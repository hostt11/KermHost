# Render Blueprint pour KermHost
# Documentation: https://render.com/docs/blueprint-spec

services:
  # Service principal - API et Frontend
  - type: web
    name: kermhost
    env: node
    region: frankfurt  # ou singapore, ohio, oregon
    plan: pro  # starter, pro, advanced
    buildCommand: npm install && npm run build
    startCommand: npm start
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: APP_URL
        sync: false
      - key: SESSION_SECRET
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: EMAIL_FROM
        value: onboarding@resend.dev
      - key: EMAIL_NAME
        value: KermHost
      - key: DAILY_COINS_REWARD
        value: 10
      - key: REFERRAL_COINS_REWARD
        value: 10
      - key: BOT_DEPLOYMENT_COST
        value: 10
      - key: MAX_BOTS_PER_USER
        value: 10
      - key: DEFAULT_USER_COINS
        value: 10
      - key: HEROKU_API_KEY
        sync: false
      - key: HEROKU_APP_LIMIT_PER_ACCOUNT
        value: 100
      - key: HEROKU_REGION
        value: eu
      - key: CORS_ORIGIN
        value: https://kermhost.com
      - key: RATE_LIMIT_WINDOW
        value: 15
      - key: RATE_LIMIT_MAX
        value: 100
      - key: MAX_FILE_SIZE
        value: 5242880
      - key: LOG_LEVEL
        value: info
      - key: MAINTENANCE_MODE
        value: false
      - key: ENABLE_EMAIL_NOTIFICATIONS
        value: true
      - key: CACHE_ENABLED
        value: true
      - key: CACHE_TTL
        value: 300
    domains:
      - kermhost.com
      - www.kermhost.com
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
      - path: /*
        name: X-XSS-Protection
        value: 1; mode=block
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
      - path: /*
        name: Content-Security-Policy
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: https://files.catbox.moe https://*.githubusercontent.com; connect-src 'self' https://api.supabase.co https://api.heroku.com https://api.github.com https://api.resend.com"
    disk:
      name: uploads
      mountPath: /opt/render/project/src/uploads
      sizeGB: 10

  # Service de cron pour les t√¢ches planifi√©es
  - type: cron
    name: kermhost-cron
    env: node
    region: frankfurt
    schedule: "0 */6 * * *"  # Toutes les 6 heures
    startCommand: node scripts/cron.js
    envVars:
      - fromService:
          name: kermhost
          type: web
          property: env
    plan: starter

  # Worker pour le traitement en arri√®re-plan
  - type: worker
    name: kermhost-worker
    env: node
    region: frankfurt
    plan: starter
    startCommand: node scripts/worker.js
    envVars:
      - fromService:
          name: kermhost
          type: web
          property: env

  # Service de base de donn√©es (PostgreSQL sur Supabase)
  # Note: Nous utilisons Supabase, mais voici la config si vous voulez utiliser Render PostgreSQL
  - type: pserv
    name: kermhost-db
    region: frankfurt
    plan: starter  # starter, pro, advanced
    disk:
      name: data
      mountPath: /var/lib/postgresql/data
      sizeGB: 10
    ipAllowList:
      - source: 0.0.0.0/0
        description: "Allow all for development"
    databases:
      - name: kermhost_prod
        databaseName: kermhost
        user: kermhost_admin

# Variables d'environnement globales
envVarGroups:
  - name: production
    envVars:
      - key: NODE_ENV
        value: production
      - key: APP_NAME
        value: KermHost
      - key: LOG_FILE
        value: /var/log/kermhost/app.log
      - key: ERROR_LOG_FILE
        value: /var/log/kermhost/error.log
      - key: UPLOAD_PATH
        value: /opt/render/project/src/uploads

# Scripts de d√©ploiement
preDeploy:
  - echo "üöÄ D√©ploiement de KermHost en cours..."
  - npm run lint
  - npm test

postDeploy:
  - echo "‚úÖ D√©ploiement termin√© avec succ√®s!"
  - node scripts/post-deploy.js

# Notifications
notifications:
  - type: slack
    channel: deployments
    events:
      - deploy_succeeded
      - deploy_failed
      - deploy_live
